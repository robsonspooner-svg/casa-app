import { AutonomyLevel, RiskLevel } from '../types/autonomy';
import { ErrorCategory, RESILIENCE_PRESETS } from '../types/resilience';
import type { ToolDefinition } from '../types/tools';
import type { ToolResilience } from '../types/resilience';

// ─── Resilience Helpers ─────────────────────────────────────────────────────

const queryResilience: ToolResilience = {
  ...RESILIENCE_PRESETS.query,
  circuitBreaker: undefined,
};

const actionResilience = (overrides?: Partial<ToolResilience>): ToolResilience => ({
  ...RESILIENCE_PRESETS.action,
  ...overrides,
});

const generateResilience: ToolResilience = {
  ...RESILIENCE_PRESETS.generate,
  circuitBreaker: {
    failureThreshold: 3,
    failureWindowMs: 60_000,
    halfOpenAfterMs: 30_000,
    halfOpenMaxAttempts: 1,
  },
};

const integrationResilience = (
  service: string,
  overrides?: Partial<ToolResilience>
): ToolResilience => ({
  ...RESILIENCE_PRESETS.integration,
  circuitBreaker: {
    failureThreshold: 3,
    failureWindowMs: 120_000,
    halfOpenAfterMs: 60_000,
    halfOpenMaxAttempts: 1,
  },
  ...overrides,
});

const paymentResilience: ToolResilience = {
  ...RESILIENCE_PRESETS.payment,
  circuitBreaker: {
    failureThreshold: 3,
    failureWindowMs: 60_000,
    halfOpenAfterMs: 30_000,
    halfOpenMaxAttempts: 1,
  },
};

// ─── 3.1 QUERY TOOLS ────────────────────────────────────────────────────────

const QUERY_TOOLS: ToolDefinition[] = [
  {
    name: 'get_property',
    description: 'Get property details including address, features, tenancy, and compliance',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        include: { type: 'array', items: { type: 'string', enum: ['tenancy', 'compliance', 'financials', 'maintenance'] }, description: 'Optional related data to include' },
      },
      required: ['property_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 3,
    resilience: queryResilience,
  },
  {
    name: 'get_properties',
    description: 'List all owner\'s properties with summary stats',
    input_schema: {
      type: 'object',
      properties: {
        status: { type: 'string', enum: ['active', 'vacant', 'all'], description: 'Filter by property status' },
        limit: { type: 'number', description: 'Max results to return' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 3,
    resilience: queryResilience,
  },
  {
    name: 'search_tenants',
    description: 'Search tenants by name, email, phone, or property',
    input_schema: {
      type: 'object',
      properties: {
        query: { type: 'string', description: 'Search query (name, email, phone)' },
        property_id: { type: 'string', description: 'Filter by property' },
        status: { type: 'string', enum: ['active', 'past', 'all'], description: 'Tenancy status filter' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 6,
    resilience: queryResilience,
  },
  {
    name: 'get_tenancy',
    description: 'Get active tenancy: tenants, lease dates, rent, bond status',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        property_id: { type: 'string', description: 'Or lookup by property' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 6,
    resilience: queryResilience,
  },
  {
    name: 'get_payments',
    description: 'Get payment history with amounts and statuses',
    input_schema: {
      type: 'object',
      properties: {
        tenant_id: { type: 'string', description: 'Filter by tenant' },
        property_id: { type: 'string', description: 'Filter by property' },
        period: { type: 'string', enum: ['week', 'month', 'quarter', 'year', 'all'], description: 'Time period' },
        status: { type: 'string', enum: ['paid', 'pending', 'failed', 'all'], description: 'Payment status' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 7,
    resilience: queryResilience,
  },
  {
    name: 'get_rent_schedule',
    description: 'Get upcoming rent due dates and amounts',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        include_paid: { type: 'boolean', description: 'Include already-paid periods' },
      },
      required: ['tenancy_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 7,
    resilience: queryResilience,
  },
  {
    name: 'get_arrears',
    description: 'Get all tenants in arrears with days overdue and escalation level',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        min_days: { type: 'number', description: 'Minimum days overdue' },
        severity: { type: 'string', enum: ['friendly', 'formal', 'breach', 'critical'], description: 'Escalation level filter' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 8,
    resilience: queryResilience,
  },
  {
    name: 'get_maintenance',
    description: 'Get maintenance requests filtered by property/status/urgency',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        status: { type: 'string', enum: ['submitted', 'acknowledged', 'awaiting_quote', 'approved', 'scheduled', 'in_progress', 'completed', 'cancelled', 'on_hold', 'all'], description: 'Request status (matches maintenance_status enum)' },
        urgency: { type: 'string', enum: ['emergency', 'urgent', 'routine'], description: 'Urgency level (matches maintenance_urgency enum)' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 9,
    resilience: queryResilience,
  },
  {
    name: 'get_maintenance_detail',
    description: 'Full maintenance request: quotes, photos, comments, timeline',
    input_schema: {
      type: 'object',
      properties: {
        request_id: { type: 'string', description: 'Maintenance request UUID' },
      },
      required: ['request_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 9,
    resilience: queryResilience,
  },
  {
    name: 'get_quotes',
    description: 'Get all quotes for a maintenance request with trade rankings',
    input_schema: {
      type: 'object',
      properties: {
        request_id: { type: 'string', description: 'Maintenance request UUID' },
      },
      required: ['request_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 10,
    resilience: queryResilience,
  },
  {
    name: 'get_inspections',
    description: 'Get inspection history and upcoming scheduled inspections',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        type: { type: 'string', enum: ['entry', 'routine', 'exit', 'all'], description: 'Inspection type' },
        status: { type: 'string', enum: ['scheduled', 'completed', 'cancelled', 'all'], description: 'Status filter' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 11,
    resilience: queryResilience,
  },
  {
    name: 'get_listings',
    description: 'Get listings with view/enquiry/application counts',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        status: { type: 'string', enum: ['draft', 'active', 'paused', 'leased', 'all'], description: 'Listing status' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 4,
    resilience: queryResilience,
  },
  {
    name: 'get_applications',
    description: 'Get applications for a listing with scores and screening',
    input_schema: {
      type: 'object',
      properties: {
        listing_id: { type: 'string', description: 'Listing UUID' },
        status: { type: 'string', enum: ['pending', 'shortlisted', 'accepted', 'rejected', 'all'], description: 'Application status' },
        top_n: { type: 'number', description: 'Return top N ranked applications' },
      },
      required: ['listing_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 5,
    resilience: queryResilience,
  },
  {
    name: 'get_application_detail',
    description: 'Full application: documents, references, checks, score',
    input_schema: {
      type: 'object',
      properties: {
        application_id: { type: 'string', description: 'Application UUID' },
      },
      required: ['application_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 5,
    resilience: queryResilience,
  },
  {
    name: 'get_conversations',
    description: 'Get message threads across properties',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        unread_only: { type: 'boolean', description: 'Only unread threads' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 12,
    resilience: queryResilience,
  },
  {
    name: 'get_compliance_status',
    description: 'Get compliance status for properties (smoke alarms, gas, pool, etc.)',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        overdue_only: { type: 'boolean', description: 'Only overdue items' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 15,
    resilience: queryResilience,
  },
  {
    name: 'get_financial_summary',
    description: 'Get income, expenses, net position for period',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        period: { type: 'string', enum: ['month', 'quarter', 'year', 'custom'], description: 'Reporting period' },
        start_date: { type: 'string', description: 'Start date (ISO 8601) for custom period' },
        end_date: { type: 'string', description: 'End date (ISO 8601) for custom period' },
      },
      required: ['period'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 13,
    resilience: queryResilience,
  },
  {
    name: 'get_property_metrics',
    description: 'Get per-property performance metrics (vacancy, income, maintenance costs, arrears)',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by specific property' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 13,
    resilience: queryResilience,
  },
  {
    name: 'get_expenses',
    description: 'Get expense records for tax reporting and financial analysis',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        period: { type: 'string', enum: ['month', 'quarter', 'year', 'financial_year', 'all'], description: 'Time period' },
        category: { type: 'string', description: 'Expense category filter' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 13,
    resilience: queryResilience,
  },
  {
    name: 'get_transactions',
    description: 'Get itemized transactions (rent, bond, maintenance, fees)',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        type: { type: 'string', enum: ['rent', 'bond', 'maintenance', 'fee', 'all'], description: 'Transaction type' },
        period: { type: 'string', enum: ['month', 'quarter', 'year', 'all'], description: 'Time period' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 7,
    resilience: queryResilience,
  },
  {
    name: 'get_trades',
    description: 'Search tradesperson network by category/area/rating',
    input_schema: {
      type: 'object',
      properties: {
        category: { type: 'string', description: 'Trade category (plumber, electrician, etc.)' },
        postcode: { type: 'string', description: 'Service area postcode' },
        min_rating: { type: 'number', description: 'Minimum rating (1-5)' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 10,
    resilience: queryResilience,
  },
  {
    name: 'get_background_tasks',
    description: 'Get status of running background tasks',
    input_schema: {
      type: 'object',
      properties: {
        status: { type: 'string', enum: ['running', 'completed', 'failed', 'all'], description: 'Task status filter' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 3,
    resilience: queryResilience,
  },
  {
    name: 'get_pending_actions',
    description: 'Get all actions awaiting owner approval',
    input_schema: {
      type: 'object',
      properties: {
        status: { type: 'string', enum: ['pending', 'expired', 'all'], description: 'Approval status' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 3,
    resilience: queryResilience,
  },
  {
    name: 'get_documents',
    description: 'Get documents for a property or tenancy',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        tenancy_id: { type: 'string', description: 'Filter by tenancy' },
        type: { type: 'string', enum: ['lease', 'inspection', 'notice', 'receipt', 'compliance', 'all'], description: 'Document type' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 15,
    resilience: queryResilience,
  },
  {
    name: 'get_inspection_detail',
    description: 'Get full inspection: rooms, items, condition ratings, photos, tenant response',
    input_schema: {
      type: 'object',
      properties: {
        inspection_id: { type: 'string', description: 'Inspection UUID' },
      },
      required: ['inspection_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 11,
    resilience: queryResilience,
  },
  {
    name: 'get_tenancy_detail',
    description: 'Full tenancy: tenants, lease dates, rent, bond, documents, rent increases, payment history',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
      },
      required: ['tenancy_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 6,
    resilience: queryResilience,
  },
  {
    name: 'get_listing_detail',
    description: 'Full listing: features, policies, photos, view count, application count, portal status',
    input_schema: {
      type: 'object',
      properties: {
        listing_id: { type: 'string', description: 'Listing UUID' },
      },
      required: ['listing_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 4,
    resilience: queryResilience,
  },
  {
    name: 'get_work_orders',
    description: 'Get work orders for a property or trade with status and cost details',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Filter by property' },
        trade_id: { type: 'string', description: 'Filter by tradesperson' },
        status: { type: 'string', enum: ['pending', 'accepted', 'in_progress', 'completed', 'cancelled', 'all'], description: 'Work order status' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 10,
    resilience: queryResilience,
  },
  {
    name: 'get_arrears_detail',
    description: 'Full arrears record: amount, days overdue, actions taken, payment plan, escalation level',
    input_schema: {
      type: 'object',
      properties: {
        arrears_id: { type: 'string', description: 'Arrears record UUID' },
        tenancy_id: { type: 'string', description: 'Or lookup by tenancy' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 8,
    resilience: queryResilience,
  },
  {
    name: 'get_conversation_messages',
    description: 'Get messages for a conversation thread with sender details and attachments',
    input_schema: {
      type: 'object',
      properties: {
        conversation_id: { type: 'string', description: 'Conversation UUID' },
        limit: { type: 'number', description: 'Max messages to return' },
        before: { type: 'string', description: 'Fetch messages before this timestamp (ISO 8601)' },
      },
      required: ['conversation_id'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 12,
    resilience: queryResilience,
  },
  {
    name: 'get_payment_plan',
    description: 'Get payment plan details including installments and status',
    input_schema: {
      type: 'object',
      properties: {
        payment_plan_id: { type: 'string', description: 'Payment plan UUID' },
        tenancy_id: { type: 'string', description: 'Or lookup by tenancy' },
      },
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 8,
    resilience: queryResilience,
  },
];

// ─── 3.2 ACTION TOOLS ──────────────────────────────────────────────────────

const ACTION_TOOLS: ToolDefinition[] = [
  {
    name: 'send_message',
    description: 'Send message to tenant via preferred channel',
    input_schema: {
      type: 'object',
      properties: {
        tenant_id: { type: 'string', description: 'Recipient tenant UUID' },
        content: { type: 'string', description: 'Message content' },
        channel: { type: 'string', enum: ['in_app', 'email', 'sms', 'preferred'], description: 'Delivery channel' },
        priority: { type: 'string', enum: ['normal', 'urgent'], description: 'Message priority' },
      },
      required: ['tenant_id', 'content'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 12,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'alternative_tool', alternativeTool: 'send_push_expo' },
      idempotency: { required: true, keyFields: ['tenant_id', 'content'], ttlSeconds: 300 },
    }),
  },
  {
    name: 'send_rent_reminder',
    description: 'Send templated rent reminder to tenant',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        tone: { type: 'string', enum: ['friendly', 'formal'], description: 'Message tone' },
        include_amount: { type: 'boolean', description: 'Include amount due in reminder' },
      },
      required: ['tenancy_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 8,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 600_000 },
      idempotency: { required: true, keyFields: ['tenancy_id', 'tone'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'send_receipt',
    description: 'Send payment receipt to tenant',
    input_schema: {
      type: 'object',
      properties: {
        payment_id: { type: 'string', description: 'Payment UUID' },
        tenant_id: { type: 'string', description: 'Recipient tenant' },
      },
      required: ['payment_id', 'tenant_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 7,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 2_000, maxDelayMs: 8_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 300_000 },
      idempotency: { required: true, keyFields: ['payment_id', 'tenant_id'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'send_breach_notice',
    description: 'Generate and send state-compliant breach notice',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        breach_type: { type: 'string', enum: ['rent_arrears', 'property_damage', 'noise', 'pets', 'other'], description: 'Type of breach' },
        details: { type: 'string', description: 'Breach details' },
        state: { type: 'string', enum: ['NSW', 'VIC', 'QLD', 'SA', 'WA', 'TAS', 'NT', 'ACT'], description: 'State for compliance' },
      },
      required: ['tenancy_id', 'breach_type', 'details', 'state'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Inform,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 8,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 15_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'breach_type'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'create_maintenance',
    description: 'Create new maintenance request',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        title: { type: 'string', description: 'Short description' },
        description: { type: 'string', description: 'Detailed description' },
        urgency: { type: 'string', enum: ['emergency', 'urgent', 'routine', 'cosmetic'], description: 'Urgency level' },
        category: { type: 'string', description: 'Maintenance category (plumbing, electrical, etc.)' },
        reported_by: { type: 'string', enum: ['tenant', 'owner', 'agent', 'inspector'], description: 'Who reported it' },
      },
      required: ['property_id', 'title', 'urgency', 'category'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 9,
    compensationTool: 'update_maintenance_status',
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['property_id', 'title', 'category'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'update_maintenance_status',
    description: 'Update maintenance request status',
    input_schema: {
      type: 'object',
      properties: {
        request_id: { type: 'string', description: 'Maintenance request UUID' },
        status: { type: 'string', enum: ['submitted', 'acknowledged', 'awaiting_quote', 'approved', 'scheduled', 'in_progress', 'completed', 'cancelled', 'on_hold'], description: 'New status (matches maintenance_status enum)' },
        notes: { type: 'string', description: 'Status change notes' },
      },
      required: ['request_id', 'status'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 9,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['request_id', 'status'], ttlSeconds: 300 },
    }),
  },
  {
    name: 'schedule_inspection',
    description: 'Schedule inspection with tenant notification',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        type: { type: 'string', enum: ['entry', 'routine', 'exit'], description: 'Inspection type' },
        preferred_date: { type: 'string', description: 'Preferred date (ISO 8601)' },
        notify_tenant: { type: 'boolean', description: 'Send tenant notification' },
      },
      required: ['property_id', 'type', 'preferred_date'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 11,
    compensationTool: 'cancel_inspection',
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 300_000 },
      idempotency: { required: true, keyFields: ['property_id', 'type', 'preferred_date'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'cancel_inspection',
    description: 'Cancel a scheduled inspection',
    input_schema: {
      type: 'object',
      properties: {
        inspection_id: { type: 'string', description: 'Inspection UUID' },
        reason: { type: 'string', description: 'Cancellation reason' },
        notify_tenant: { type: 'boolean', description: 'Notify tenant of cancellation' },
      },
      required: ['inspection_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 11,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['inspection_id'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'approve_quote',
    description: 'Approve maintenance quote, schedule trade',
    input_schema: {
      type: 'object',
      properties: {
        quote_id: { type: 'string', description: 'Quote UUID' },
        request_id: { type: 'string', description: 'Maintenance request UUID' },
        preferred_schedule: { type: 'string', description: 'Preferred trade visit date' },
      },
      required: ['quote_id', 'request_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 10,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['quote_id'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'reject_quote',
    description: 'Reject a maintenance quote with reason',
    input_schema: {
      type: 'object',
      properties: {
        quote_id: { type: 'string', description: 'Quote UUID' },
        reason: { type: 'string', description: 'Rejection reason' },
        request_alternative: { type: 'boolean', description: 'Request alternative quote' },
      },
      required: ['quote_id', 'reason'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 10,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['quote_id'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'create_work_order',
    description: 'Create work order for tradesperson',
    input_schema: {
      type: 'object',
      properties: {
        request_id: { type: 'string', description: 'Maintenance request UUID' },
        trade_id: { type: 'string', description: 'Tradesperson UUID' },
        scope: { type: 'string', description: 'Work scope description' },
        budget: { type: 'number', description: 'Approved budget (AUD)' },
        scheduled_date: { type: 'string', description: 'Scheduled date (ISO 8601)' },
      },
      required: ['request_id', 'trade_id', 'scope', 'budget'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 10,
    compensationTool: 'update_maintenance_status',
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['request_id', 'trade_id'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'accept_application',
    description: 'Approve tenant application (triggers onboarding workflow)',
    input_schema: {
      type: 'object',
      properties: {
        application_id: { type: 'string', description: 'Application UUID' },
        move_in_date: { type: 'string', description: 'Proposed move-in date (ISO 8601)' },
        custom_conditions: { type: 'string', description: 'Any special conditions' },
      },
      required: ['application_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 5,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['application_id'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'reject_application',
    description: 'Reject tenant application with reason',
    input_schema: {
      type: 'object',
      properties: {
        application_id: { type: 'string', description: 'Application UUID' },
        reason: { type: 'string', description: 'Rejection reason' },
        send_notification: { type: 'boolean', description: 'Notify applicant' },
      },
      required: ['application_id', 'reason'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 5,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['application_id'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'shortlist_application',
    description: 'Move application to shortlist',
    input_schema: {
      type: 'object',
      properties: {
        application_id: { type: 'string', description: 'Application UUID' },
        notes: { type: 'string', description: 'Shortlisting notes' },
      },
      required: ['application_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 5,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['application_id'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'retry_payment',
    description: 'Retry a failed rent payment (max 1 auto-retry)',
    input_schema: {
      type: 'object',
      properties: {
        payment_id: { type: 'string', description: 'Failed payment UUID' },
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
      },
      required: ['payment_id', 'tenancy_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 7,
    resilience: {
      ...paymentResilience,
      idempotency: { required: true, keyFields: ['payment_id'], ttlSeconds: 172_800 },
    },
  },
  {
    name: 'process_payment',
    description: 'Process a rent payment charge',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        amount: { type: 'number', description: 'Amount in AUD' },
        description: { type: 'string', description: 'Payment description' },
      },
      required: ['tenancy_id', 'amount'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 7,
    resilience: paymentResilience,
  },
  {
    name: 'change_rent_amount',
    description: 'Change rent on tenancy (requires notice period)',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        new_amount: { type: 'number', description: 'New weekly rent (AUD)' },
        effective_date: { type: 'string', description: 'Effective date (ISO 8601)' },
        reason: { type: 'string', description: 'Reason for change' },
      },
      required: ['tenancy_id', 'new_amount', 'effective_date'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Inform,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 7,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'new_amount', 'effective_date'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'lodge_bond',
    description: 'Lodge bond with state authority',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        amount: { type: 'number', description: 'Bond amount (AUD)' },
        state: { type: 'string', enum: ['NSW', 'VIC', 'QLD', 'SA', 'WA', 'TAS', 'NT', 'ACT'], description: 'State for lodgement' },
      },
      required: ['tenancy_id', 'amount', 'state'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 6,
    resilience: {
      retry: { maxAttempts: 3, baseDelayMs: 5_000, maxDelayMs: 45_000, backoffMultiplier: 3, jitterMs: 1_000, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 60_000, tier: 'long' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 300_000 },
      idempotency: { required: true, keyFields: ['tenancy_id', 'amount'], ttlSeconds: 86_400 },
    },
  },
  {
    name: 'claim_bond',
    description: 'Initiate bond claim (partial or full)',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        amount: { type: 'number', description: 'Claim amount (AUD)' },
        reason: { type: 'string', description: 'Claim reason with evidence references' },
        claim_type: { type: 'string', enum: ['full', 'partial'], description: 'Full or partial claim' },
      },
      required: ['tenancy_id', 'amount', 'reason', 'claim_type'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Inform,
    riskLevel: RiskLevel.Critical,
    reversible: false,
    availableFromMission: 6,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 5_000, maxDelayMs: 15_000, backoffMultiplier: 3, jitterMs: 1_000, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 30_000, tier: 'extended' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'claim_type'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'create_listing',
    description: 'Create new property listing (draft)',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        title: { type: 'string', description: 'Listing title' },
        description: { type: 'string', description: 'Listing description' },
        rent_weekly: { type: 'number', description: 'Weekly rent (AUD)' },
        available_date: { type: 'string', description: 'Available date (ISO 8601)' },
        photos: { type: 'array', items: { type: 'string' }, description: 'Photo URLs' },
      },
      required: ['property_id', 'title', 'rent_weekly'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 4,
    compensationTool: 'update_maintenance_status',
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['property_id', 'title'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'publish_listing',
    description: 'Publish draft listing to portals',
    input_schema: {
      type: 'object',
      properties: {
        listing_id: { type: 'string', description: 'Listing UUID' },
        portals: { type: 'array', items: { type: 'string', enum: ['domain', 'rea', 'both'] }, description: 'Target portals' },
      },
      required: ['listing_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 4,
    compensationTool: 'pause_listing',
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 15_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['listing_id'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'pause_listing',
    description: 'Pause an active listing',
    input_schema: {
      type: 'object',
      properties: {
        listing_id: { type: 'string', description: 'Listing UUID' },
        reason: { type: 'string', description: 'Pause reason' },
      },
      required: ['listing_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 4,
    compensationTool: 'publish_listing',
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['listing_id'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'update_listing',
    description: 'Update listing details',
    input_schema: {
      type: 'object',
      properties: {
        listing_id: { type: 'string', description: 'Listing UUID' },
        updates: { type: 'object', description: 'Fields to update' },
      },
      required: ['listing_id', 'updates'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 4,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['listing_id'], ttlSeconds: 300 },
    }),
  },
  {
    name: 'terminate_lease',
    description: 'Initiate lease termination',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        termination_type: { type: 'string', enum: ['mutual', 'owner_notice', 'tenant_notice', 'breach'], description: 'Termination type' },
        effective_date: { type: 'string', description: 'Termination effective date (ISO 8601)' },
        reason: { type: 'string', description: 'Termination reason' },
      },
      required: ['tenancy_id', 'termination_type', 'effective_date'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Inform,
    riskLevel: RiskLevel.Critical,
    reversible: false,
    availableFromMission: 6,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 5_000, maxDelayMs: 15_000, backoffMultiplier: 3, jitterMs: 1_000, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 15_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'termination_type'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'record_compliance',
    description: 'Record compliance completion with evidence',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        compliance_type: { type: 'string', enum: ['smoke_alarm', 'gas_safety', 'pool_fence', 'electrical', 'other'], description: 'Compliance type' },
        completed_date: { type: 'string', description: 'Completion date (ISO 8601)' },
        next_due_date: { type: 'string', description: 'Next due date (ISO 8601)' },
        evidence_url: { type: 'string', description: 'URL to evidence document/photo' },
      },
      required: ['property_id', 'compliance_type', 'completed_date'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 15,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['property_id', 'compliance_type', 'completed_date'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'create_payment_plan',
    description: 'Create payment plan for tenant in arrears',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        total_arrears: { type: 'number', description: 'Total arrears amount (AUD)' },
        installment_amount: { type: 'number', description: 'Weekly installment (AUD)' },
        start_date: { type: 'string', description: 'Plan start date (ISO 8601)' },
      },
      required: ['tenancy_id', 'total_arrears', 'installment_amount'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 8,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'escalate_arrears',
    description: 'Move arrears to next escalation level',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        current_level: { type: 'string', enum: ['friendly', 'formal', 'breach', 'tribunal'], description: 'Current escalation level' },
        next_level: { type: 'string', enum: ['formal', 'breach', 'tribunal', 'eviction'], description: 'Target escalation level' },
      },
      required: ['tenancy_id', 'current_level', 'next_level'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 8,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'next_level'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'update_autopay',
    description: 'Enable/disable auto-pay settings',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        enabled: { type: 'boolean', description: 'Enable or disable auto-pay' },
        method: { type: 'string', enum: ['card', 'becs', 'bpay'], description: 'Payment method' },
      },
      required: ['tenancy_id', 'enabled'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 7,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'enabled'], ttlSeconds: 3_600 },
    }),
  },
  // ── Property CRUD ──────────────────────────────────────────────────────────
  {
    name: 'create_property',
    description: 'Create a new property with address, details, and financials. The agent can create a property via conversation by collecting required fields and calling this tool',
    input_schema: {
      type: 'object',
      properties: {
        address_line_1: { type: 'string', description: 'Street address (e.g. "42 Ocean Road")' },
        address_line_2: { type: 'string', description: 'Unit/apartment (optional)' },
        suburb: { type: 'string', description: 'Suburb name' },
        state: { type: 'string', enum: ['NSW', 'VIC', 'QLD', 'SA', 'WA', 'TAS', 'NT', 'ACT'], description: 'Australian state' },
        postcode: { type: 'string', description: '4-digit postcode' },
        property_type: { type: 'string', enum: ['house', 'apartment', 'townhouse', 'unit', 'studio', 'other'], description: 'Property type' },
        bedrooms: { type: 'number', description: 'Number of bedrooms' },
        bathrooms: { type: 'number', description: 'Number of bathrooms' },
        parking_spaces: { type: 'number', description: 'Number of parking spaces' },
        floor_size_sqm: { type: 'number', description: 'Floor area in square metres' },
        land_size_sqm: { type: 'number', description: 'Land area in square metres' },
        year_built: { type: 'number', description: 'Year the property was built' },
        rent_amount: { type: 'number', description: 'Rent amount in AUD' },
        rent_frequency: { type: 'string', enum: ['weekly', 'fortnightly', 'monthly'], description: 'Rent frequency' },
        bond_amount: { type: 'number', description: 'Bond amount in AUD' },
        notes: { type: 'string', description: 'Any additional notes about the property' },
      },
      required: ['address_line_1', 'suburb', 'state', 'postcode'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 3,
    compensationTool: 'delete_property',
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['address_line_1', 'suburb', 'postcode'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'update_property',
    description: 'Update property details — address, features, financials, notes. Use to fill in missing fields after initial creation',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        updates: {
          type: 'object',
          description: 'Fields to update. Any subset of: address_line_1, address_line_2, suburb, state, postcode, property_type, bedrooms, bathrooms, parking_spaces, floor_size_sqm, land_size_sqm, year_built, rent_amount, rent_frequency, bond_amount, notes, status',
        },
      },
      required: ['property_id', 'updates'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 3,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['property_id'], ttlSeconds: 300 },
    }),
  },
  {
    name: 'delete_property',
    description: 'Soft-delete a property (sets deleted_at timestamp, can be undone)',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        reason: { type: 'string', description: 'Reason for deletion' },
      },
      required: ['property_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Inform,
    riskLevel: RiskLevel.High,
    reversible: true,
    availableFromMission: 3,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['property_id'], ttlSeconds: 86_400 },
    }),
  },
  // ── Tenancy CRUD ───────────────────────────────────────────────────────────
  {
    name: 'create_tenancy',
    description: 'Create a new tenancy for a property — sets up lease, tenants, bond, and generates rent schedule',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        tenant_ids: { type: 'array', items: { type: 'string' }, description: 'Tenant user UUIDs' },
        lease_type: { type: 'string', enum: ['fixed', 'periodic'], description: 'Lease type' },
        lease_start_date: { type: 'string', description: 'Lease start date (ISO 8601)' },
        lease_end_date: { type: 'string', description: 'Lease end date (ISO 8601)' },
        rent_amount: { type: 'number', description: 'Rent amount in AUD' },
        rent_frequency: { type: 'string', enum: ['weekly', 'fortnightly', 'monthly'], description: 'Rent frequency' },
        rent_due_day: { type: 'number', description: 'Day of week/month rent is due (1-31)' },
        bond_amount: { type: 'number', description: 'Bond amount in AUD' },
        notes: { type: 'string', description: 'Additional notes' },
      },
      required: ['property_id', 'lease_start_date', 'rent_amount', 'rent_frequency'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 6,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 15_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['property_id', 'lease_start_date'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'update_tenancy',
    description: 'Update tenancy fields — rent, dates, status, notes',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        updates: {
          type: 'object',
          description: 'Fields to update: rent_amount, rent_frequency, lease_end_date, notes, status',
        },
      },
      required: ['tenancy_id', 'updates'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 6,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id'], ttlSeconds: 300 },
    }),
  },
  {
    name: 'renew_lease',
    description: 'Renew an existing lease with new dates and optional rent adjustment',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        new_end_date: { type: 'string', description: 'New lease end date (ISO 8601)' },
        new_rent_amount: { type: 'number', description: 'New rent amount (if changing)' },
        lease_type: { type: 'string', enum: ['fixed', 'periodic'], description: 'New lease type' },
      },
      required: ['tenancy_id', 'new_end_date'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 6,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'new_end_date'], ttlSeconds: 86_400 },
    }),
  },
  // ── Maintenance Comments ───────────────────────────────────────────────────
  {
    name: 'add_maintenance_comment',
    description: 'Add a comment to a maintenance request thread',
    input_schema: {
      type: 'object',
      properties: {
        request_id: { type: 'string', description: 'Maintenance request UUID' },
        content: { type: 'string', description: 'Comment content' },
        is_internal: { type: 'boolean', description: 'Internal note (not visible to tenant)' },
      },
      required: ['request_id', 'content'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 9,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 60_000 },
      idempotency: { required: true, keyFields: ['request_id', 'content'], ttlSeconds: 300 },
    }),
  },
  {
    name: 'record_maintenance_cost',
    description: 'Record estimated or actual cost for a maintenance request',
    input_schema: {
      type: 'object',
      properties: {
        request_id: { type: 'string', description: 'Maintenance request UUID' },
        estimated_cost: { type: 'number', description: 'Estimated cost in AUD' },
        actual_cost: { type: 'number', description: 'Actual cost in AUD (after completion)' },
        cost_responsibility: { type: 'string', enum: ['owner', 'tenant', 'insurance', 'warranty'], description: 'Who bears the cost' },
      },
      required: ['request_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 9,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['request_id'], ttlSeconds: 300 },
    }),
  },
  // ── Work Order Management ──────────────────────────────────────────────────
  {
    name: 'update_work_order_status',
    description: 'Update work order status (accept, start, complete, cancel)',
    input_schema: {
      type: 'object',
      properties: {
        work_order_id: { type: 'string', description: 'Work order UUID' },
        status: { type: 'string', enum: ['accepted', 'in_progress', 'completed', 'cancelled'], description: 'New status' },
        notes: { type: 'string', description: 'Status change notes' },
        actual_cost: { type: 'number', description: 'Actual cost upon completion (AUD)' },
      },
      required: ['work_order_id', 'status'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 10,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['work_order_id', 'status'], ttlSeconds: 3_600 },
    }),
  },
  // ── Trade Network Management ───────────────────────────────────────────────
  {
    name: 'add_trade_to_network',
    description: 'Add an existing tradesperson to the owner\'s preferred trade network',
    input_schema: {
      type: 'object',
      properties: {
        trade_id: { type: 'string', description: 'Trade UUID' },
        notes: { type: 'string', description: 'Notes about this trade' },
        is_favorite: { type: 'boolean', description: 'Mark as favorite' },
      },
      required: ['trade_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.None,
    reversible: true,
    availableFromMission: 10,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['trade_id'], ttlSeconds: 3_600 },
    }),
  },
  // ── In-App Messaging ───────────────────────────────────────────────────────
  {
    name: 'create_conversation',
    description: 'Create a new in-app conversation thread with participants',
    input_schema: {
      type: 'object',
      properties: {
        participant_ids: { type: 'array', items: { type: 'string' }, description: 'User UUIDs to include in conversation' },
        property_id: { type: 'string', description: 'Related property (optional context)' },
        subject: { type: 'string', description: 'Conversation subject' },
        initial_message: { type: 'string', description: 'First message to send' },
      },
      required: ['participant_ids'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 12,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['participant_ids', 'subject'], ttlSeconds: 3_600 },
    }),
  },
  {
    name: 'send_in_app_message',
    description: 'Send a message in an existing in-app conversation thread',
    input_schema: {
      type: 'object',
      properties: {
        conversation_id: { type: 'string', description: 'Conversation UUID' },
        content: { type: 'string', description: 'Message content' },
      },
      required: ['conversation_id', 'content'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 12,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 60_000 },
      idempotency: { required: true, keyFields: ['conversation_id', 'content'], ttlSeconds: 300 },
    }),
  },
  // ── Arrears Resolution ─────────────────────────────────────────────────────
  {
    name: 'resolve_arrears',
    description: 'Mark an arrears record as resolved',
    input_schema: {
      type: 'object',
      properties: {
        arrears_id: { type: 'string', description: 'Arrears record UUID' },
        resolution_reason: { type: 'string', description: 'How the arrears were resolved' },
      },
      required: ['arrears_id', 'resolution_reason'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 8,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['arrears_id'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'log_arrears_action',
    description: 'Log an action taken on an arrears case — phone call, email, note, or any other communication',
    input_schema: {
      type: 'object',
      properties: {
        arrears_id: { type: 'string', description: 'Arrears record UUID' },
        action_type: { type: 'string', enum: ['phone_call', 'email', 'sms', 'note', 'letter', 'visit'], description: 'Type of action' },
        description: { type: 'string', description: 'Description of what was done' },
        outcome: { type: 'string', description: 'Result of the action' },
      },
      required: ['arrears_id', 'action_type', 'description'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 8,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 60_000 },
      idempotency: { required: true, keyFields: ['arrears_id', 'action_type', 'description'], ttlSeconds: 300 },
    }),
  },
  // ── Rent Increase ──────────────────────────────────────────────────────────
  {
    name: 'create_rent_increase',
    description: 'Create a rent increase notice for a tenancy with state-compliant notice period',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        new_amount: { type: 'number', description: 'New rent amount in AUD' },
        effective_date: { type: 'string', description: 'Date the increase takes effect (ISO 8601)' },
        reason: { type: 'string', description: 'Reason for increase (e.g. "market adjustment", "CPI")' },
      },
      required: ['tenancy_id', 'new_amount', 'effective_date'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: true,
    availableFromMission: 7,
    compensationTool: 'cancel_rent_increase',
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'new_amount', 'effective_date'], ttlSeconds: 86_400 },
    }),
  },
  {
    name: 'cancel_rent_increase',
    description: 'Cancel a pending rent increase notice',
    input_schema: {
      type: 'object',
      properties: {
        rent_increase_id: { type: 'string', description: 'Rent increase UUID' },
      },
      required: ['rent_increase_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 7,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['rent_increase_id'], ttlSeconds: 86_400 },
    }),
  },
  // ── Connection Management ──────────────────────────────────────────────────
  {
    name: 'invite_tenant',
    description: 'Send a direct invitation to a tenant to connect them to a property',
    input_schema: {
      type: 'object',
      properties: {
        email: { type: 'string', description: 'Tenant email address' },
        property_id: { type: 'string', description: 'Property UUID to connect them to' },
        name: { type: 'string', description: 'Tenant name (for personalized invite)' },
      },
      required: ['email', 'property_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 6,
    resilience: actionResilience({
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 300_000 },
      idempotency: { required: true, keyFields: ['email', 'property_id'], ttlSeconds: 86_400 },
    }),
  },
  // ── Inspection Report ──────────────────────────────────────────────────────
  {
    name: 'submit_trade_review',
    description: 'Submit a review and rating for a tradesperson after work completion',
    input_schema: {
      type: 'object',
      properties: {
        trade_id: { type: 'string', description: 'Trade UUID' },
        work_order_id: { type: 'string', description: 'Work order UUID' },
        rating: { type: 'number', description: 'Rating 1-5' },
        review_text: { type: 'string', description: 'Written review' },
        would_recommend: { type: 'boolean', description: 'Would recommend to others' },
      },
      required: ['trade_id', 'rating'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 10,
    resilience: actionResilience({
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 8_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['trade_id', 'work_order_id'], ttlSeconds: 86_400 },
    }),
  },
];

// ─── 3.3 GENERATE TOOLS ─────────────────────────────────────────────────────

const GENERATE_TOOLS: ToolDefinition[] = [
  {
    name: 'generate_listing',
    description: 'Generate listing copy from property data and photos',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        tone: { type: 'string', enum: ['professional', 'friendly', 'luxury'], description: 'Writing tone' },
        highlights: { type: 'array', items: { type: 'string' }, description: 'Features to emphasize' },
      },
      required: ['property_id'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 4,
    resilience: generateResilience,
  },
  {
    name: 'draft_message',
    description: 'Draft message with specified purpose and tone',
    input_schema: {
      type: 'object',
      properties: {
        purpose: { type: 'string', description: 'Message purpose (rent_reminder, welcome, maintenance_update, etc.)' },
        context: { type: 'object', description: 'Context data for the message' },
        tone: { type: 'string', enum: ['friendly', 'formal', 'urgent'], description: 'Message tone' },
        recipient_type: { type: 'string', enum: ['tenant', 'owner', 'trade'], description: 'Recipient type' },
      },
      required: ['purpose', 'tone', 'recipient_type'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 12,
    resilience: generateResilience,
  },
  {
    name: 'score_application',
    description: 'AI-score application (0-100) with reasoning',
    input_schema: {
      type: 'object',
      properties: {
        application_id: { type: 'string', description: 'Application UUID' },
        criteria_weights: { type: 'object', description: 'Custom weighting for scoring criteria' },
      },
      required: ['application_id'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 5,
    resilience: generateResilience,
  },
  {
    name: 'rank_applications',
    description: 'Rank and compare multiple applications',
    input_schema: {
      type: 'object',
      properties: {
        listing_id: { type: 'string', description: 'Listing UUID' },
        application_ids: { type: 'array', items: { type: 'string' }, description: 'Applications to rank' },
        prioritize: { type: 'string', enum: ['income', 'history', 'references', 'balanced'], description: 'Ranking priority' },
      },
      required: ['listing_id', 'application_ids'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 5,
    resilience: generateResilience,
  },
  {
    name: 'triage_maintenance',
    description: 'Categorize urgency, estimate cost, suggest action',
    input_schema: {
      type: 'object',
      properties: {
        request_id: { type: 'string', description: 'Maintenance request UUID' },
        description: { type: 'string', description: 'Issue description' },
        photos: { type: 'array', items: { type: 'string' }, description: 'Photo URLs' },
      },
      required: ['request_id'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 9,
    resilience: generateResilience,
  },
  {
    name: 'estimate_cost',
    description: 'Estimate maintenance cost from description + market rates',
    input_schema: {
      type: 'object',
      properties: {
        category: { type: 'string', description: 'Trade category' },
        description: { type: 'string', description: 'Work description' },
        postcode: { type: 'string', description: 'Property postcode for market rates' },
      },
      required: ['category', 'description'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 9,
    resilience: generateResilience,
  },
  {
    name: 'analyze_rent',
    description: 'Analyze rent vs market with recommendation',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        current_rent: { type: 'number', description: 'Current weekly rent (AUD)' },
        include_comparables: { type: 'boolean', description: 'Include comparable properties' },
      },
      required: ['property_id'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 13,
    resilience: generateResilience,
  },
  {
    name: 'generate_notice',
    description: 'Generate state-compliant legal notice',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        notice_type: { type: 'string', enum: ['breach', 'termination', 'rent_increase', 'entry', 'renovation'], description: 'Notice type' },
        state: { type: 'string', enum: ['NSW', 'VIC', 'QLD', 'SA', 'WA', 'TAS', 'NT', 'ACT'], description: 'State for compliance' },
        details: { type: 'object', description: 'Notice-specific details' },
      },
      required: ['tenancy_id', 'notice_type', 'state'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Inform,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 8,
    resilience: generateResilience,
  },
  {
    name: 'generate_inspection_report',
    description: 'Generate report from photos and condition data',
    input_schema: {
      type: 'object',
      properties: {
        inspection_id: { type: 'string', description: 'Inspection UUID' },
        photos: { type: 'array', items: { type: 'string' }, description: 'Inspection photo URLs' },
        notes: { type: 'string', description: 'Inspector notes' },
      },
      required: ['inspection_id'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 11,
    resilience: generateResilience,
  },
  {
    name: 'compare_inspections',
    description: 'Compare entry vs exit inspection with change detection',
    input_schema: {
      type: 'object',
      properties: {
        entry_inspection_id: { type: 'string', description: 'Entry inspection UUID' },
        exit_inspection_id: { type: 'string', description: 'Exit inspection UUID' },
      },
      required: ['entry_inspection_id', 'exit_inspection_id'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 11,
    resilience: generateResilience,
  },
  {
    name: 'generate_financial_report',
    description: 'Generate monthly/quarterly financial summary',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID (or all)' },
        period: { type: 'string', enum: ['month', 'quarter', 'year'], description: 'Report period' },
        include_projections: { type: 'boolean', description: 'Include cash flow projections' },
      },
      required: ['period'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 13,
    resilience: generateResilience,
  },
  {
    name: 'suggest_rent_price',
    description: 'Suggest optimal rent from comparables',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        strategy: { type: 'string', enum: ['market_rate', 'quick_let', 'premium'], description: 'Pricing strategy' },
      },
      required: ['property_id'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 4,
    resilience: generateResilience,
  },
  {
    name: 'generate_lease',
    description: 'Generate state-compliant lease document',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        state: { type: 'string', enum: ['NSW', 'VIC', 'QLD', 'SA', 'WA', 'TAS', 'NT', 'ACT'], description: 'State for compliance' },
        lease_type: { type: 'string', enum: ['fixed', 'periodic'], description: 'Lease type' },
        term_months: { type: 'number', description: 'Fixed term length (months)' },
        special_conditions: { type: 'array', items: { type: 'string' }, description: 'Special conditions' },
      },
      required: ['tenancy_id', 'state', 'lease_type'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 6,
    resilience: generateResilience,
  },
  {
    name: 'generate_tax_report',
    description: 'Generate tax-ready income and expense summary for financial year (AU: July-June)',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID (or all properties)' },
        financial_year: { type: 'string', description: 'Financial year (e.g. "2024-2025")' },
        include_depreciation: { type: 'boolean', description: 'Include depreciation schedule estimates' },
      },
      required: ['financial_year'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 13,
    resilience: generateResilience,
  },
  {
    name: 'generate_property_summary',
    description: 'Generate a comprehensive summary of a property including performance metrics, tenant history, maintenance record, and compliance status',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        include_history: { type: 'boolean', description: 'Include historical tenancy and maintenance data' },
      },
      required: ['property_id'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 3,
    resilience: generateResilience,
  },
];

// ─── 3.4 INTEGRATION TOOLS ─────────────────────────────────────────────────

const INTEGRATION_TOOLS: ToolDefinition[] = [
  {
    name: 'syndicate_listing_domain',
    description: 'Post/update listing on Domain.com.au',
    input_schema: {
      type: 'object',
      properties: {
        listing_id: { type: 'string', description: 'Listing UUID' },
        action: { type: 'string', enum: ['create', 'update', 'remove'], description: 'Syndication action' },
      },
      required: ['listing_id', 'action'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 4,
    resilience: integrationResilience('domain', {
      retry: { maxAttempts: 3, baseDelayMs: 5_000, maxDelayMs: 45_000, backoffMultiplier: 3, jitterMs: 1_000, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 30_000, tier: 'extended' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 300_000 },
      idempotency: { required: true, keyFields: ['listing_id', 'action'], ttlSeconds: 3_600 },
      circuitBreaker: { failureThreshold: 5, failureWindowMs: 300_000, halfOpenAfterMs: 120_000, halfOpenMaxAttempts: 1 },
    }),
  },
  {
    name: 'syndicate_listing_rea',
    description: 'Post/update listing on realestate.com.au',
    input_schema: {
      type: 'object',
      properties: {
        listing_id: { type: 'string', description: 'Listing UUID' },
        action: { type: 'string', enum: ['create', 'update', 'remove'], description: 'Syndication action' },
      },
      required: ['listing_id', 'action'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: true,
    availableFromMission: 4,
    resilience: integrationResilience('rea', {
      retry: { maxAttempts: 3, baseDelayMs: 5_000, maxDelayMs: 45_000, backoffMultiplier: 3, jitterMs: 1_000, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 30_000, tier: 'extended' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 300_000 },
      idempotency: { required: true, keyFields: ['listing_id', 'action'], ttlSeconds: 3_600 },
      circuitBreaker: { failureThreshold: 5, failureWindowMs: 300_000, halfOpenAfterMs: 120_000, halfOpenMaxAttempts: 1 },
    }),
  },
  {
    name: 'run_credit_check',
    description: 'Run Equifax credit check on applicant',
    input_schema: {
      type: 'object',
      properties: {
        application_id: { type: 'string', description: 'Application UUID' },
        applicant_name: { type: 'string', description: 'Full legal name' },
        date_of_birth: { type: 'string', description: 'DOB (ISO 8601)' },
      },
      required: ['application_id', 'applicant_name', 'date_of_birth'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 5,
    resilience: integrationResilience('equifax', {
      retry: { maxAttempts: 2, baseDelayMs: 10_000, maxDelayMs: 30_000, backoffMultiplier: 3, jitterMs: 2_000, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 60_000, tier: 'long' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 600_000 },
      idempotency: { required: true, keyFields: ['application_id', 'applicant_name'], ttlSeconds: 86_400 },
      circuitBreaker: { failureThreshold: 3, failureWindowMs: 120_000, halfOpenAfterMs: 60_000, halfOpenMaxAttempts: 1 },
    }),
  },
  {
    name: 'run_tica_check',
    description: 'Run TICA tenancy database check',
    input_schema: {
      type: 'object',
      properties: {
        application_id: { type: 'string', description: 'Application UUID' },
        applicant_name: { type: 'string', description: 'Full legal name' },
        previous_addresses: { type: 'array', items: { type: 'string' }, description: 'Previous rental addresses' },
      },
      required: ['application_id', 'applicant_name'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 5,
    resilience: integrationResilience('tica', {
      retry: { maxAttempts: 2, baseDelayMs: 10_000, maxDelayMs: 30_000, backoffMultiplier: 3, jitterMs: 2_000, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 45_000, tier: 'extended' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 600_000 },
      idempotency: { required: true, keyFields: ['application_id', 'applicant_name'], ttlSeconds: 86_400 },
      circuitBreaker: { failureThreshold: 3, failureWindowMs: 120_000, halfOpenAfterMs: 60_000, halfOpenMaxAttempts: 1 },
    }),
  },
  {
    name: 'collect_rent_stripe',
    description: 'Charge rent via Stripe Connect',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        amount: { type: 'number', description: 'Amount in AUD' },
        payment_method: { type: 'string', enum: ['card', 'becs'], description: 'Payment method' },
        description: { type: 'string', description: 'Payment description' },
      },
      required: ['tenancy_id', 'amount', 'payment_method'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 7,
    resilience: {
      ...paymentResilience,
      circuitBreaker: { failureThreshold: 3, failureWindowMs: 60_000, halfOpenAfterMs: 30_000, halfOpenMaxAttempts: 1 },
      idempotency: { required: true, keyFields: ['tenancy_id', 'amount'], ttlSeconds: 172_800 },
    },
  },
  {
    name: 'refund_payment_stripe',
    description: 'Process refund via Stripe',
    input_schema: {
      type: 'object',
      properties: {
        payment_id: { type: 'string', description: 'Original payment UUID' },
        amount: { type: 'number', description: 'Refund amount (AUD, partial or full)' },
        reason: { type: 'string', description: 'Refund reason' },
      },
      required: ['payment_id', 'amount', 'reason'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Inform,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 7,
    resilience: {
      retry: { maxAttempts: 2, baseDelayMs: 5_000, maxDelayMs: 15_000, backoffMultiplier: 3, jitterMs: 1_000, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 30_000, tier: 'extended' },
      circuitBreaker: { failureThreshold: 3, failureWindowMs: 60_000, halfOpenAfterMs: 30_000, halfOpenMaxAttempts: 1 },
      fallback: { strategy: 'queue', queueRetryAfterMs: 300_000 },
      idempotency: { required: true, keyFields: ['payment_id', 'amount'], ttlSeconds: 86_400 },
    },
  },
  {
    name: 'send_docusign_envelope',
    description: 'Send lease for e-signing via DocuSign',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        document_url: { type: 'string', description: 'Lease document URL' },
        signers: { type: 'array', items: { type: 'object', properties: { name: { type: 'string' }, email: { type: 'string' } } }, description: 'Signing parties' },
      },
      required: ['tenancy_id', 'document_url', 'signers'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 6,
    resilience: integrationResilience('docusign', {
      retry: { maxAttempts: 3, baseDelayMs: 10_000, maxDelayMs: 60_000, backoffMultiplier: 2, jitterMs: 2_000, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 60_000, tier: 'long' },
      fallback: { strategy: 'alternative_tool', alternativeTool: 'send_email_sendgrid' },
      idempotency: { required: true, keyFields: ['tenancy_id', 'document_url'], ttlSeconds: 86_400 },
      circuitBreaker: { failureThreshold: 3, failureWindowMs: 120_000, halfOpenAfterMs: 60_000, halfOpenMaxAttempts: 1 },
    }),
  },
  {
    name: 'lodge_bond_state',
    description: 'Lodge bond with state authority (NSW/VIC/QLD)',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        amount: { type: 'number', description: 'Bond amount (AUD)' },
        state: { type: 'string', enum: ['NSW', 'VIC', 'QLD', 'SA', 'WA', 'TAS', 'NT', 'ACT'], description: 'State authority' },
        tenant_details: { type: 'object', description: 'Tenant name, DOB, address' },
      },
      required: ['tenancy_id', 'amount', 'state'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 6,
    resilience: integrationResilience('bond_state', {
      retry: { maxAttempts: 3, baseDelayMs: 30_000, maxDelayMs: 120_000, backoffMultiplier: 2, jitterMs: 5_000, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 120_000, tier: 'workflow' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 600_000 },
      idempotency: { required: true, keyFields: ['tenancy_id', 'amount', 'state'], ttlSeconds: 86_400 },
      circuitBreaker: { failureThreshold: 3, failureWindowMs: 300_000, halfOpenAfterMs: 300_000, halfOpenMaxAttempts: 1 },
    }),
  },
  {
    name: 'send_sms_twilio',
    description: 'Send SMS via Twilio',
    input_schema: {
      type: 'object',
      properties: {
        to: { type: 'string', description: 'Recipient phone number (E.164)' },
        body: { type: 'string', description: 'SMS body (max 1600 chars)' },
        template: { type: 'string', description: 'Template name (optional)' },
      },
      required: ['to', 'body'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 12,
    resilience: integrationResilience('twilio', {
      retry: { maxAttempts: 3, baseDelayMs: 2_000, maxDelayMs: 8_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 10_000, tier: 'standard' },
      fallback: { strategy: 'alternative_tool', alternativeTool: 'send_email_sendgrid' },
      idempotency: { required: true, keyFields: ['to', 'body'], ttlSeconds: 300 },
      circuitBreaker: { failureThreshold: 5, failureWindowMs: 60_000, halfOpenAfterMs: 30_000, halfOpenMaxAttempts: 2 },
    }),
  },
  {
    name: 'send_email_sendgrid',
    description: 'Send email via SendGrid',
    input_schema: {
      type: 'object',
      properties: {
        to: { type: 'string', description: 'Recipient email address' },
        subject: { type: 'string', description: 'Email subject' },
        body: { type: 'string', description: 'Email body (HTML or plain text)' },
        template_id: { type: 'string', description: 'SendGrid template ID (optional)' },
        template_data: { type: 'object', description: 'Template substitution data' },
      },
      required: ['to', 'subject', 'body'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 12,
    resilience: integrationResilience('sendgrid', {
      retry: { maxAttempts: 3, baseDelayMs: 2_000, maxDelayMs: 8_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 15_000, tier: 'standard' },
      fallback: { strategy: 'alternative_tool', alternativeTool: 'send_push_expo' },
      idempotency: { required: true, keyFields: ['to', 'subject'], ttlSeconds: 300 },
      circuitBreaker: { failureThreshold: 5, failureWindowMs: 60_000, halfOpenAfterMs: 30_000, halfOpenMaxAttempts: 2 },
    }),
  },
  {
    name: 'send_push_expo',
    description: 'Send push notification via Expo',
    input_schema: {
      type: 'object',
      properties: {
        user_id: { type: 'string', description: 'User UUID (resolves to push token)' },
        title: { type: 'string', description: 'Notification title' },
        body: { type: 'string', description: 'Notification body' },
        data: { type: 'object', description: 'Custom data payload' },
      },
      required: ['user_id', 'title', 'body'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 12,
    resilience: integrationResilience('expo', {
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 8_000, tier: 'fast' },
      fallback: { strategy: 'alternative_tool', alternativeTool: 'send_sms_twilio' },
      idempotency: { required: true, keyFields: ['user_id', 'title', 'body'], ttlSeconds: 60 },
      circuitBreaker: { failureThreshold: 10, failureWindowMs: 60_000, halfOpenAfterMs: 15_000, halfOpenMaxAttempts: 3 },
    }),
  },
  {
    name: 'search_trades_hipages',
    description: 'Search tradespeople on Hipages',
    input_schema: {
      type: 'object',
      properties: {
        category: { type: 'string', description: 'Trade category' },
        postcode: { type: 'string', description: 'Service area postcode' },
        urgency: { type: 'string', enum: ['emergency', 'standard'], description: 'Job urgency' },
      },
      required: ['category', 'postcode'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 10,
    resilience: integrationResilience('hipages', {
      retry: { maxAttempts: 3, baseDelayMs: 5_000, maxDelayMs: 20_000, backoffMultiplier: 2, jitterMs: 1_000, retryableErrors: [ErrorCategory.Transient, ErrorCategory.Degraded] },
      timeout: { executionMs: 30_000, tier: 'extended' },
      fallback: { strategy: 'cache', cacheMaxAgeMs: 604_800_000 },
      idempotency: { required: false, keyFields: [], ttlSeconds: 0 },
      circuitBreaker: { failureThreshold: 5, failureWindowMs: 300_000, halfOpenAfterMs: 120_000, halfOpenMaxAttempts: 1 },
    }),
  },
];

// ─── 3.5 WORKFLOW TOOLS ─────────────────────────────────────────────────────

const WORKFLOW_TOOLS: ToolDefinition[] = [
  {
    name: 'workflow_find_tenant',
    description: 'Full workflow: list → syndicate → screen → recommend',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        preferences: { type: 'object', description: 'Listing and screening preferences' },
      },
      required: ['property_id'],
    },
    category: 'workflow',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 4,
    resilience: {
      retry: { maxAttempts: 1, baseDelayMs: 0, maxDelayMs: 0, backoffMultiplier: 1, jitterMs: 0, retryableErrors: [] },
      timeout: { executionMs: 120_000, tier: 'workflow' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['property_id'], ttlSeconds: 86_400 },
    },
  },
  {
    name: 'workflow_onboard_tenant',
    description: 'Onboard workflow: lease → sign → bond → inspection',
    input_schema: {
      type: 'object',
      properties: {
        application_id: { type: 'string', description: 'Accepted application UUID' },
        move_in_date: { type: 'string', description: 'Move-in date (ISO 8601)' },
      },
      required: ['application_id'],
    },
    category: 'workflow',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 6,
    resilience: {
      retry: { maxAttempts: 1, baseDelayMs: 0, maxDelayMs: 0, backoffMultiplier: 1, jitterMs: 0, retryableErrors: [] },
      timeout: { executionMs: 120_000, tier: 'workflow' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['application_id'], ttlSeconds: 86_400 },
    },
  },
  {
    name: 'workflow_end_tenancy',
    description: 'End tenancy: exit inspection → bond → relist',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        relist: { type: 'boolean', description: 'Whether to relist after vacancy' },
      },
      required: ['tenancy_id'],
    },
    category: 'workflow',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 6,
    resilience: {
      retry: { maxAttempts: 1, baseDelayMs: 0, maxDelayMs: 0, backoffMultiplier: 1, jitterMs: 0, retryableErrors: [] },
      timeout: { executionMs: 120_000, tier: 'workflow' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id'], ttlSeconds: 86_400 },
    },
  },
  {
    name: 'workflow_maintenance_lifecycle',
    description: 'Full maintenance: report → triage → quote → approve → complete',
    input_schema: {
      type: 'object',
      properties: {
        request_id: { type: 'string', description: 'Maintenance request UUID' },
        auto_approve_threshold: { type: 'number', description: 'Auto-approve if under this amount (AUD)' },
      },
      required: ['request_id'],
    },
    category: 'workflow',
    autonomyLevel: AutonomyLevel.Draft,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 9,
    resilience: {
      retry: { maxAttempts: 1, baseDelayMs: 0, maxDelayMs: 0, backoffMultiplier: 1, jitterMs: 0, retryableErrors: [] },
      timeout: { executionMs: 120_000, tier: 'workflow' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['request_id'], ttlSeconds: 86_400 },
    },
  },
  {
    name: 'workflow_arrears_escalation',
    description: 'Arrears ladder: reminder → formal → notice → tribunal',
    input_schema: {
      type: 'object',
      properties: {
        tenancy_id: { type: 'string', description: 'Tenancy UUID' },
        current_days_overdue: { type: 'number', description: 'Current days in arrears' },
      },
      required: ['tenancy_id', 'current_days_overdue'],
    },
    category: 'workflow',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.High,
    reversible: false,
    availableFromMission: 8,
    resilience: {
      retry: { maxAttempts: 1, baseDelayMs: 0, maxDelayMs: 0, backoffMultiplier: 1, jitterMs: 0, retryableErrors: [] },
      timeout: { executionMs: 120_000, tier: 'workflow' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: true, keyFields: ['tenancy_id'], ttlSeconds: 86_400 },
    },
  },
];

// ─── 3.6 MEMORY TOOLS ──────────────────────────────────────────────────────

const MEMORY_TOOLS: ToolDefinition[] = [
  {
    name: 'remember',
    description: 'Store owner preference or fact for future use',
    input_schema: {
      type: 'object',
      properties: {
        key: { type: 'string', description: 'What to remember (category.key format)' },
        value: { type: 'string', description: 'The value or fact to store' },
        property_id: { type: 'string', description: 'Property scope (optional)' },
        confidence: { type: 'number', description: 'Confidence level (0-1)' },
      },
      required: ['key', 'value'],
    },
    category: 'memory',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: true,
    availableFromMission: 3,
    resilience: {
      retry: { maxAttempts: 3, baseDelayMs: 1_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 200, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 5_000, tier: 'fast' },
      fallback: { strategy: 'queue', queueRetryAfterMs: 60_000 },
      idempotency: { required: true, keyFields: ['key', 'value'], ttlSeconds: 60 },
    },
  },
  {
    name: 'recall',
    description: 'Retrieve preferences relevant to current context',
    input_schema: {
      type: 'object',
      properties: {
        context: { type: 'string', description: 'Current context description for relevance matching' },
        category: { type: 'string', description: 'Preference category filter' },
        property_id: { type: 'string', description: 'Property scope filter' },
      },
      required: ['context'],
    },
    category: 'memory',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 3,
    resilience: queryResilience,
  },
  {
    name: 'search_precedent',
    description: 'Search past decisions via pgvector for similar context',
    input_schema: {
      type: 'object',
      properties: {
        query: { type: 'string', description: 'Natural language description of situation' },
        tool_name: { type: 'string', description: 'Filter by tool used' },
        limit: { type: 'number', description: 'Max results' },
      },
      required: ['query'],
    },
    category: 'memory',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: queryResilience,
  },
  {
    name: 'get_owner_rules',
    description: 'Get all active learned rules for owner',
    input_schema: {
      type: 'object',
      properties: {
        category: { type: 'string', description: 'Rule category filter' },
        property_id: { type: 'string', description: 'Property scope filter' },
        min_confidence: { type: 'number', description: 'Minimum confidence threshold' },
      },
    },
    category: 'memory',
    autonomyLevel: AutonomyLevel.Autonomous,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 15,
    resilience: queryResilience,
  },
];

// ─── 3.7 PLANNING TOOLS ─────────────────────────────────────────────────────

const PLANNING_TOOLS: ToolDefinition[] = [
  {
    name: 'plan_task',
    description: 'Break complex request into ordered steps with tool assignments',
    input_schema: {
      type: 'object',
      properties: {
        request: { type: 'string', description: 'User request to decompose' },
        context: { type: 'object', description: 'Current conversation/property context' },
      },
      required: ['request'],
    },
    category: 'planning',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: {
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 15_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: false, keyFields: [], ttlSeconds: 0 },
    },
  },
  {
    name: 'check_plan',
    description: 'Review progress, identify next steps or blockers',
    input_schema: {
      type: 'object',
      properties: {
        plan_id: { type: 'string', description: 'Plan UUID' },
        completed_steps: { type: 'array', items: { type: 'number' }, description: 'Indices of completed steps' },
      },
      required: ['plan_id'],
    },
    category: 'planning',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: queryResilience,
  },
  {
    name: 'replan',
    description: 'Revise plan after failure or changed circumstances',
    input_schema: {
      type: 'object',
      properties: {
        plan_id: { type: 'string', description: 'Original plan UUID' },
        failure_reason: { type: 'string', description: 'What went wrong' },
        new_context: { type: 'object', description: 'Updated context' },
      },
      required: ['plan_id', 'failure_reason'],
    },
    category: 'planning',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: {
      retry: { maxAttempts: 2, baseDelayMs: 2_000, maxDelayMs: 4_000, backoffMultiplier: 2, jitterMs: 500, retryableErrors: [ErrorCategory.Transient] },
      timeout: { executionMs: 15_000, tier: 'standard' },
      fallback: { strategy: 'manual_escalation' },
      idempotency: { required: false, keyFields: [], ttlSeconds: 0 },
    },
  },
];

// ─── EXTERNAL TOOLS (Web / Discovery / Automation) ──────────────────────────

const EXTERNAL_TOOLS: ToolDefinition[] = [
  {
    name: 'web_search',
    description: 'Search the web for information relevant to property management — local regulations, market rates, service providers, compliance requirements, or any other research needed',
    input_schema: {
      type: 'object',
      properties: {
        query: { type: 'string', description: 'Search query' },
        region: { type: 'string', description: 'Region to focus results (e.g. "Melbourne, VIC"). Defaults to Australia' },
        max_results: { type: 'number', description: 'Maximum results to return. Defaults to 5' },
      },
      required: ['query'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: integrationResilience('web_search'),
  },
  {
    name: 'find_local_trades',
    description: 'Search for local tradespeople and service providers near a property. Returns business name, contact, ratings, distance, specialisations. Uses web search + business directory APIs',
    input_schema: {
      type: 'object',
      properties: {
        trade_type: { type: 'string', description: 'Type of trade (plumber, electrician, locksmith, cleaner, pest_control, gardener, handyman, builder, painter, roofer)' },
        property_id: { type: 'string', description: 'Property UUID to find trades near' },
        suburb: { type: 'string', description: 'Suburb to search in (fallback if property_id not given)' },
        urgency: { type: 'string', enum: ['emergency', 'urgent', 'routine'], description: 'How urgently the trade is needed' },
        max_results: { type: 'number', description: 'Maximum providers to return. Defaults to 5' },
      },
      required: ['trade_type'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.Low,
    reversible: false,
    availableFromMission: 14,
    resilience: integrationResilience('trades_search'),
  },
  {
    name: 'parse_business_details',
    description: 'Extract structured business information from a webpage URL or business listing — ABN, license numbers, insurance status, ratings, contact details, operating hours',
    input_schema: {
      type: 'object',
      properties: {
        url: { type: 'string', description: 'Business webpage URL' },
        business_name: { type: 'string', description: 'Business name (for validation)' },
      },
      required: ['url'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: integrationResilience('business_parse'),
  },
  {
    name: 'create_service_provider',
    description: 'Create or update a service provider card in the system with structured business details, license info, insurance status, and rating data',
    input_schema: {
      type: 'object',
      properties: {
        business_name: { type: 'string', description: 'Business name' },
        trade_type: { type: 'string', description: 'Primary trade category' },
        contact_name: { type: 'string', description: 'Primary contact name' },
        phone: { type: 'string', description: 'Phone number' },
        email: { type: 'string', description: 'Email address' },
        abn: { type: 'string', description: 'Australian Business Number' },
        license_number: { type: 'string', description: 'Trade license number' },
        insurance_status: { type: 'string', enum: ['verified', 'unverified', 'expired'] },
        rating: { type: 'number', description: 'Average rating (1-5)' },
        suburb: { type: 'string', description: 'Business suburb' },
        state: { type: 'string', description: 'Business state' },
        notes: { type: 'string', description: 'Any additional notes' },
      },
      required: ['business_name', 'trade_type', 'phone'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Low,
    reversible: true,
    availableFromMission: 14,
    resilience: actionResilience(),
  },
  {
    name: 'request_quote',
    description: 'Send a quote request to a tradesperson or service provider. Includes maintenance details, photos, property access info, and preferred scheduling',
    input_schema: {
      type: 'object',
      properties: {
        provider_id: { type: 'string', description: 'Service provider UUID (from trades table)' },
        maintenance_request_id: { type: 'string', description: 'Related maintenance request UUID' },
        property_id: { type: 'string', description: 'Property UUID' },
        description: { type: 'string', description: 'Work description for the quote' },
        urgency: { type: 'string', enum: ['emergency', 'urgent', 'routine'] },
        preferred_dates: { type: 'array', items: { type: 'string' }, description: 'Preferred dates for the work (ISO format)' },
        access_instructions: { type: 'string', description: 'How to access the property' },
        photos: { type: 'array', items: { type: 'string' }, description: 'URLs of relevant photos' },
      },
      required: ['description', 'property_id'],
    },
    category: 'action',
    autonomyLevel: AutonomyLevel.Suggest,
    riskLevel: RiskLevel.Medium,
    reversible: false,
    availableFromMission: 14,
    resilience: actionResilience(),
  },
  {
    name: 'check_maintenance_threshold',
    description: 'Check if a maintenance repair cost falls within the owner-configured auto-approval threshold. Returns whether the action can proceed autonomously or needs owner approval',
    input_schema: {
      type: 'object',
      properties: {
        property_id: { type: 'string', description: 'Property UUID' },
        estimated_cost: { type: 'number', description: 'Estimated repair cost in AUD' },
        category: { type: 'string', description: 'Maintenance category (plumbing, electrical, structural, appliance, cosmetic, garden, pest)' },
        is_tenant_caused: { type: 'boolean', description: 'Whether the damage was caused by the tenant' },
      },
      required: ['property_id', 'estimated_cost', 'category'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: queryResilience,
  },
  {
    name: 'assess_tenant_damage',
    description: 'Analyse maintenance photos and description to determine if damage is likely tenant-caused (vs wear and tear). Returns assessment with confidence and evidence reasoning',
    input_schema: {
      type: 'object',
      properties: {
        maintenance_request_id: { type: 'string', description: 'Maintenance request UUID' },
        description: { type: 'string', description: 'Description of the damage' },
        photo_urls: { type: 'array', items: { type: 'string' }, description: 'URLs of damage photos' },
        property_age_years: { type: 'number', description: 'Age of the property in years' },
        tenancy_duration_months: { type: 'number', description: 'How long the current tenant has been there' },
        last_inspection_notes: { type: 'string', description: 'Notes from the last inspection for comparison' },
      },
      required: ['description'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: generateResilience,
  },
  {
    name: 'compare_quotes',
    description: 'Compare multiple quotes for a maintenance job. Considers price, provider rating, availability, insurance status, and historical performance. Returns ranked recommendations',
    input_schema: {
      type: 'object',
      properties: {
        maintenance_request_id: { type: 'string', description: 'Maintenance request UUID' },
        quote_ids: { type: 'array', items: { type: 'string' }, description: 'Quote UUIDs to compare' },
        priority_factors: { type: 'object', properties: { price_weight: { type: 'number' }, quality_weight: { type: 'number' }, speed_weight: { type: 'number' } }, description: 'Weight factors for ranking (0-1)' },
      },
      required: ['maintenance_request_id', 'quote_ids'],
    },
    category: 'generate',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: generateResilience,
  },
  {
    name: 'get_market_data',
    description: 'Fetch current rental market data for a suburb or property type — median rents, vacancy rates, yield, growth trends. Used for rent reviews and listing pricing',
    input_schema: {
      type: 'object',
      properties: {
        suburb: { type: 'string', description: 'Suburb name' },
        state: { type: 'string', description: 'State (e.g. VIC, NSW, QLD)' },
        property_type: { type: 'string', enum: ['house', 'apartment', 'townhouse', 'unit'] },
        bedrooms: { type: 'number', description: 'Number of bedrooms' },
      },
      required: ['suburb', 'state'],
    },
    category: 'integration',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: integrationResilience('market_data'),
  },
  {
    name: 'check_regulatory_requirements',
    description: 'Check state-specific regulatory requirements for a property management action — smoke alarm compliance, pool safety, minimum standards, notice periods, etc.',
    input_schema: {
      type: 'object',
      properties: {
        state: { type: 'string', description: 'Australian state (VIC, NSW, QLD, SA, WA, TAS, NT, ACT)' },
        action_type: { type: 'string', description: 'Type of action to check requirements for' },
        property_id: { type: 'string', description: 'Property UUID for specific details' },
      },
      required: ['state', 'action_type'],
    },
    category: 'query',
    autonomyLevel: AutonomyLevel.Execute,
    riskLevel: RiskLevel.None,
    reversible: false,
    availableFromMission: 14,
    resilience: queryResilience,
  },
];

// ─── COMPLETE CATALOG ───────────────────────────────────────────────────────

/**
 * Complete tool catalog — tools across 8 categories.
 * Each tool has full resilience configuration, risk classification,
 * and mission availability defined.
 */
export const TOOL_CATALOG: ToolDefinition[] = [
  ...QUERY_TOOLS,
  ...ACTION_TOOLS,
  ...GENERATE_TOOLS,
  ...INTEGRATION_TOOLS,
  ...WORKFLOW_TOOLS,
  ...MEMORY_TOOLS,
  ...PLANNING_TOOLS,
  ...EXTERNAL_TOOLS,
];

/**
 * Lookup tool definition by name.
 */
export const TOOL_BY_NAME: Record<string, ToolDefinition> = Object.fromEntries(
  TOOL_CATALOG.map(tool => [tool.name, tool])
);

/**
 * Get tools available at a given mission number.
 */
export function getToolsForMission(mission: number): ToolDefinition[] {
  return TOOL_CATALOG.filter(tool => tool.availableFromMission <= mission);
}

/**
 * Get tools by category.
 */
export function getToolsByCategory(category: ToolDefinition['category']): ToolDefinition[] {
  return TOOL_CATALOG.filter(tool => tool.category === category);
}

/**
 * Tool count verification.
 */
export const TOOL_COUNTS = {
  query: QUERY_TOOLS.length,
  action: ACTION_TOOLS.length,
  generate: GENERATE_TOOLS.length,
  integration: INTEGRATION_TOOLS.length,
  workflow: WORKFLOW_TOOLS.length,
  memory: MEMORY_TOOLS.length,
  planning: PLANNING_TOOLS.length,
  external: EXTERNAL_TOOLS.length,
  total: TOOL_CATALOG.length,
} as const;
